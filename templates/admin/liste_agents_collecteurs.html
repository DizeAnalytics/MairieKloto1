<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ titre }} - Tableau de Bord</title>
    {% load static %}
    {% if mairie_config and mairie_config.favicon %}
    <link rel="icon" href="{{ mairie_config.favicon.url }}?v={{ mairie_config.date_modification|date:'U' }}">
    <link rel="shortcut icon" href="{{ mairie_config.favicon.url }}?v={{ mairie_config.date_modification|date:'U' }}">
    {% else %}
    <link rel="icon" href="{% static 'mairie/icons/icon-192x192.png' %}">
    <link rel="shortcut icon" href="{% static 'mairie/icons/icon-192x192.png' %}">
    {% endif %}
    <link rel="stylesheet" href="{% static 'admin/css/base.css' %}">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #006233;
            --primary-dark: #004d28;
            --secondary: #FFCD00;
            --accent: #D21034;
            --dark: #1a1a1a;
            --light: #f5f5f5;
            --white: #ffffff;
            --border: #e0e0e0;
            --text-muted: #666;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background: var(--light);
        }

        .topbar {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 0.85rem 1.25rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 40;
        }
        .topbar-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        .topbar-brand { display: flex; flex-direction: column; gap: 0.1rem; }
        .topbar-title { font-size: 1.1rem; font-weight: 600; }
        .topbar-subtitle { font-size: 0.85rem; opacity: 0.85; }
        .topbar-actions { display: flex; align-items: center; gap: 0.75rem; }
        .back-link {
            color: var(--white);
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .back-link:hover { opacity: 1; }
        .hamburger {
            width: 38px;
            height: 38px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.5);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(0,0,0,0.12);
        }
        .hamburger-lines {
            width: 18px;
            height: 14px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .hamburger-line {
            height: 2px;
            border-radius: 999px;
            background: #fff;
        }

        .nav-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
            z-index: 35;
        }
        .nav-drawer {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            max-width: 80%;
            background: #ffffff;
            box-shadow: 2px 0 16px rgba(0,0,0,0.18);
            transform: translateX(-100%);
            transition: transform 0.25s ease;
            z-index: 36;
            display: flex;
            flex-direction: column;
        }
        .nav-drawer-header {
            padding: 1.25rem 1.25rem 0.75rem;
            border-bottom: 1px solid #f1f1f1;
        }
        .nav-drawer-title { font-weight: 600; font-size: 1rem; margin-bottom: 0.15rem; }
        .nav-drawer-subtitle { font-size: 0.8rem; color: var(--text-muted); }
        .nav-drawer-links { padding: 0.75rem 0.5rem 1.25rem; overflow-y: auto; }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            padding: 0.55rem 0.85rem;
            border-radius: 999px;
            text-decoration: none;
            color: #222;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        .nav-link-icon {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--light);
        }
        .nav-link:hover { background: rgba(0,98,51,0.06); color: #000; }
        .nav-link-active { background: rgba(0,98,51,0.12); font-weight: 600; }
        .nav-open .nav-overlay { opacity: 1; pointer-events: auto; }
        .nav-open .nav-drawer { transform: translateX(0); }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.25rem 1rem 2rem;
        }
        .page-header {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .page-header h2 { margin-bottom: 0.35rem; color: var(--primary); font-size: 1.35rem; }
        .page-header p { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 1rem; }
        .badge-total {
            display: inline-block;
            background: var(--primary);
            color: var(--white);
            padding: 0.35rem 0.85rem;
            border-radius: 999px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.25rem;
            background: #f8f9fa;
            padding: 1.25rem;
            border-radius: 10px;
            align-items: end;
        }
        .search-form label { display: block; font-size: 0.85rem; margin-bottom: 0.35rem; color: var(--text-muted); font-weight: 500; }
        .form-control {
            padding: 0.65rem 0.85rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
        }
        .form-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            justify-content: flex-start;
        }
        .btn-primary,
        .btn-secondary,
        .btn-add {
            border: none;
            padding: 0.8rem 1.6rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
            text-decoration: none !important;
            transition: all 0.2s ease;
            line-height: 1.5;
            min-height: 44px;
            box-sizing: border-box;
            font-family: inherit;
        }
        .btn-primary {
            background: var(--primary);
            color: white !important;
        }
        .btn-primary:hover,
        .btn-primary:focus {
            background: var(--primary-dark);
            text-decoration: none !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .btn-secondary {
            background: #6c757d;
            color: white !important;
        }
        .btn-secondary:hover,
        .btn-secondary:focus {
            background: #5a6268;
            text-decoration: none !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .btn-add {
            background: #28a745;
            color: white !important;
        }
        .btn-add:hover,
        .btn-add:focus {
            background: #218838;
            text-decoration: none !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .form-actions a,
        .form-actions button {
            text-decoration: none !important;
            border: none;
            outline: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .form-actions a:visited {
            color: white !important;
            text-decoration: none !important;
        }
        .form-actions a:active {
            transform: translateY(0);
        }
        .btn-modifier {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 0.9rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            transition: background 0.2s;
            line-height: 1.2;
        }
        .btn-modifier:hover { background: #0056b3; text-decoration: none; }

        .table-wrapper {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-top: 1.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .table-container { min-width: 800px; }
        table { width: 100%; border-collapse: collapse; }
        thead {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
        }
        th {
            padding: 1rem 0.85rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }
        td {
            padding: 0.85rem;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        tbody tr { transition: background 0.15s; }
        tbody tr:hover { background: #f8f9fa; }
        tbody tr:last-child td { border-bottom: none; }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.65rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge-actif { background: #d4edda; color: #155724; }
        .badge-inactif { background: #f8d7da; color: #721c24; }
        .badge-suspendu { background: #fff3cd; color: #856404; }
        .cell-actions { white-space: nowrap; }

        /* Modale */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }
        .modal-backdrop.active { display: flex; }
        .modal-box {
            background: var(--white);
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
        }
        .modal-header h3 {
            margin: 0;
            color: var(--primary);
            font-size: 1.25rem;
            font-weight: 600;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        .modal-body {
            padding: 1.5rem;
        }
        .modal-body .form-group {
            margin-bottom: 1.25rem;
        }
        .modal-body label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 0.4rem;
            color: #555;
            font-weight: 500;
        }
        .modal-body input,
        .modal-body select,
        .modal-body textarea {
            width: 100%;
            padding: 0.7rem 0.85rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            background-color: white;
            color: #212529;
        }
        .modal-body select {
            background-color: white !important;
            color: #212529 !important;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.85rem center;
            padding-right: 2.5rem;
        }
        /* Select Statut : affichage du libell√© (Actif/Inactif/Suspendu) via un span pour √©viter "--" */
        .statut-select-wrapper {
            position: relative;
            width: 100%;
        }
        .statut-select-wrapper select#modifier_statut {
            width: 100%;
            position: relative;
            z-index: 1;
            color: transparent !important;
            -webkit-text-fill-color: transparent !important;
            caret-color: #1a1a1a;
        }
        .statut-select-label {
            position: absolute;
            left: 0.85rem;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            pointer-events: none;
            color: #212529 !important;
            font-size: 1rem;
            z-index: 2;
            font-weight: 500;
            background-color: white;
            padding-right: 2.5rem;
        }
        .modal-body select option {
            background-color: white !important;
            color: #212529 !important;
            padding: 0.5rem;
        }
        .modal-body select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 98, 51, 0.1);
            color: #212529 !important;
        }
        .modal-body select:hover {
            color: #212529 !important;
        }
        .modal-body textarea {
            min-height: 80px;
            resize: vertical;
        }
        .modal-body .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .modal-body .emplacements-list {
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 0.75rem;
            background: #fafafa;
        }
        .modal-body .emplacements-list label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0;
            cursor: pointer;
            font-weight: normal;
            margin-bottom: 0;
        }
        .modal-body small {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.3rem;
        }
        .modal-body .btn-primary {
            width: 100%;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .container { padding: 1rem 0.75rem 1.5rem; }
            .page-header { padding: 1.1rem 1rem; }
            .page-header h2 { font-size: 1.15rem; }
            .search-form {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            .form-actions { width: 100%; }
            .btn-primary, .btn-secondary, .btn-add {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
            th, td { padding: 0.65rem 0.5rem; font-size: 0.85rem; }
            .table-wrapper { margin-left: -0.75rem; margin-right: -0.75rem; border-radius: 0; }
            .modal-box { margin: 0.5rem; max-height: 95vh; }
            .modal-body { padding: 1rem; }
            .modal-body .form-row { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .topbar-title { font-size: 0.95rem; }
            .badge-total { font-size: 0.8rem; padding: 0.3rem 0.65rem; }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="topbar-inner">
            <div class="topbar-brand">
                <div class="topbar-title">{{ titre }}</div>
                <div class="topbar-subtitle">Mairie de Kloto 1 ¬∑ Tableau de bord</div>
            </div>
            <div class="topbar-actions">
                <a href="{% url 'tableau_bord' %}" class="back-link">‚Üê Retour</a>
                <button type="button" class="hamburger" aria-label="Ouvrir le menu">
                    <div class="hamburger-lines">
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <div class="nav-overlay"></div>
    <nav class="nav-drawer" aria-label="Menu tableau de bord">
        <div class="nav-drawer-header">
            <div class="nav-drawer-title">Navigation</div>
            <div class="nav-drawer-subtitle">Tableau de bord administratif</div>
        </div>
        <div class="nav-drawer-links">
            <a href="{% url 'tableau_bord' %}" class="nav-link">
                <span class="nav-link-icon">üè†</span>
                <span>Tableau de bord</span>
            </a>
            <a href="{% url 'liste_agents_collecteurs' %}" class="nav-link nav-link-active">
                <span class="nav-link-icon">üëÆ</span>
                <span>Agents collecteurs</span>
            </a>
            <a href="{% url 'liste_contribuables' %}" class="nav-link">
                <span class="nav-link-icon">üë•</span>
                <span>Contribuables</span>
            </a>
            <a href="{% url 'liste_contributions' %}" class="nav-link">
                <span class="nav-link-icon">üí∞</span>
                <span>Contributions / taxes</span>
            </a>
            <a href="{% url 'liste_acteurs' %}" class="nav-link">
                <span class="nav-link-icon">üè¢</span>
                <span>Acteurs √©conomiques</span>
            </a>
            <a href="{% url 'liste_institutions' %}" class="nav-link">
                <span class="nav-link-icon">üè¶</span>
                <span>Institutions financi√®res</span>
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>{{ titre }}</h2>
            <p>Gestion des agents collecteurs de taxes de la mairie</p>
            <span class="badge-total">Total: {{ agents.count }} agent(s)</span>
            <div style="margin-top: 0.8rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <form method="get" action="{% url 'export_pdf_agents_collecteurs' %}" style="display:inline-flex; gap:0.5rem; align-items:center;">
                    <input type="hidden" name="q" value="{{ current_filters.q }}">
                    <input type="hidden" name="statut" value="{{ current_filters.statut }}">
                    <button type="submit" class="btn-primary" style="padding:0.5rem 1rem;">üìÑ Exporter en PDF</button>
                </form>
                <form method="get" action="{% url 'export_excel_agents_collecteurs' %}" style="display:inline-flex; gap:0.5rem; align-items:center;">
                    <input type="hidden" name="q" value="{{ current_filters.q }}">
                    <input type="hidden" name="statut" value="{{ current_filters.statut }}">
                    <button type="submit" class="btn-primary" style="padding:0.5rem 1rem; background: #2e7d32;">üìä Exporter en Excel</button>
                </form>
            </div>
            <form method="get" class="search-form">
                <div>
                    <label for="search-q">Recherche</label>
                    <input type="text" id="search-q" name="q" value="{{ current_filters.q }}" class="form-control" placeholder="Matricule, nom, t√©l√©phone...">
                </div>
                <div>
                    <label for="search-statut">Statut</label>
                    <select id="search-statut" name="statut" class="form-control">
                        <option value="">Tous</option>
                        {% for value, label in statut_choices %}
                        <option value="{{ value }}" {% if current_filters.statut == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">üîç Filtrer</button>
                    <a href="{% url 'liste_agents_collecteurs' %}" class="btn-secondary">‚Ü∫ R√©initialiser</a>
                    <a href="{% url 'ajouter_agent_collecteur' %}" class="btn-add">‚ûï Ajouter un agent</a>
                </div>
            </form>
        </div>

        <div class="table-wrapper">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Matricule</th>
                            <th>Nom complet</th>
                            <th>T√©l√©phone</th>
                            <th>Email</th>
                            <th>Statut</th>
                            <th>Emplacements</th>
                            <th>Affectations AE / IF</th>
                            <th>Date embauche</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for agent in agents %}
                        <tr>
                            <td><strong>{{ agent.matricule }}</strong></td>
                            <td>{{ agent.nom_complet }}</td>
                            <td>{{ agent.telephone }}</td>
                            <td>{{ agent.email|default:"‚Äî" }}</td>
                            <td>
                                <span class="badge badge-{{ agent.statut }}">
                                    {{ agent.get_statut_display }}
                                </span>
                            </td>
                            <td>{{ agent.emplacements_assignes.count }} emplacement(s)</td>
                            <td>
                                {{ agent.acteurs_economiques.count }} AE<br>
                                {{ agent.institutions_financieres.count }} IF
                            </td>
                            <td>{{ agent.date_embauche|date:"d/m/Y"|default:"‚Äî" }}</td>
                            <td class="cell-actions">
                                <button type="button" class="btn-modifier" 
                                    data-agent-id="{{ agent.id }}"
                                    data-matricule="{{ agent.matricule }}"
                                    data-nom="{{ agent.nom }}"
                                    data-prenom="{{ agent.prenom }}"
                                    data-telephone="{{ agent.telephone }}"
                                    data-email="{{ agent.email|default:'' }}"
                                    data-statut="{{ agent.statut }}"
                                    data-date-embauche="{% if agent.date_embauche %}{{ agent.date_embauche|date:'Y-m-d' }}{% endif %}"
                                    data-username="{{ agent.user.username }}"
                                    data-notes="{{ agent.notes|default:'' }}"
                                    data-emplacements="{% for e in agent.emplacements_assignes.all %}{{ e.id }},{% endfor %}"
                                    data-acteurs="{% for a in agent.acteurs_economiques.all %}{{ a.id }},{% endfor %}"
                                    data-institutions="{% for i in agent.institutions_financieres.all %}{{ i.id }},{% endfor %}"
                                    onclick="openModalModifierAgent(this)">
                                    ‚úèÔ∏è Modifier
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 2.5rem; color: var(--text-muted);">
                                Aucun agent collecteur trouv√©.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modale : Modifier un agent collecteur -->
    <div class="modal-backdrop" id="modalModifierAgent">
        <div class="modal-box">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'agent collecteur</h3>
                <button type="button" class="modal-close" onclick="closeModalModifierAgent()">&times;</button>
            </div>
            <div class="modal-body">
                <form method="post" id="formModifierAgent" action="{% url 'liste_agents_collecteurs' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="modifier_agent">
                    <input type="hidden" id="modifier_agent_id" name="agent_id" value="">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="modifier_matricule">Matricule *</label>
                            <input type="text" id="modifier_matricule" name="matricule" required placeholder="Ex: AGT-2026-001">
                        </div>
                        <div class="form-group">
                            <label for="modifier_statut">Statut</label>
                            <div class="statut-select-wrapper">
                                <select id="modifier_statut" name="statut">
                                    {% for value, label in statut_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <span id="modifier_statut_label" class="statut-select-label" aria-hidden="true">Actif</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="modifier_nom">Nom *</label>
                            <input type="text" id="modifier_nom" name="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="modifier_prenom">Pr√©nom *</label>
                            <input type="text" id="modifier_prenom" name="prenom" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="modifier_telephone">T√©l√©phone *</label>
                            <input type="text" id="modifier_telephone" name="telephone" required>
                        </div>
                        <div class="form-group">
                            <label for="modifier_email">Email (facultatif)</label>
                            <input type="email" id="modifier_email" name="email">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="modifier_date_embauche">Date d'embauche (facultatif)</label>
                        <input type="date" id="modifier_date_embauche" name="date_embauche">
                    </div>

                    <div class="form-group">
                        <label>Compte de connexion</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="modifier_username">Identifiant (username) *</label>
                                <input type="text" id="modifier_username" name="username" required>
                            </div>
                            <div class="form-group">
                                <label for="modifier_password">Nouveau mot de passe (laisser vide pour ne pas changer)</label>
                                <input type="password" id="modifier_password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                <small>Min. 6 caract√®res si vous souhaitez le modifier.</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Emplacements assign√©s (march√©s / places)</label>
                        <div class="emplacements-list">
                            {% for e in emplacements %}
                            <label>
                                <input type="checkbox" name="emplacements" value="{{ e.id }}" class="emplacement-checkbox">
                                {{ e.nom_lieu }} ‚Äî {{ e.quartier }}
                            </label>
                            {% empty %}
                            <p style="color:#888; font-size:0.9rem;">Aucun emplacement.</p>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Acteurs √©conomiques assign√©s</label>
                        <div class="emplacements-list">
                            {% for a in acteurs %}
                            <label>
                                <input type="checkbox" name="acteurs" value="{{ a.id }}" class="acteur-checkbox">
                                {{ a.raison_sociale }}{% if a.sigle %} ({{ a.sigle }}){% endif %}
                            </label>
                            {% empty %}
                            <p style="color:#888; font-size:0.9rem;">Aucun acteur √©conomique.</p>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Institutions financi√®res assign√©es</label>
                        <div class="emplacements-list">
                            {% for i in institutions %}
                            <label>
                                <input type="checkbox" name="institutions" value="{{ i.id }}" class="institution-checkbox">
                                {{ i.nom_institution }}{% if i.sigle %} ({{ i.sigle }}){% endif %}
                            </label>
                            {% empty %}
                            <p style="color:#888; font-size:0.9rem;">Aucune institution financi√®re.</p>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="modifier_notes">Notes (facultatif)</label>
                        <textarea id="modifier_notes" name="notes" placeholder="Formations, observations..."></textarea>
                    </div>

                    <button type="submit" class="btn-primary">‚úÖ Enregistrer les modifications</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const body = document.body;
            const burger = document.querySelector('.hamburger');
            const overlay = document.querySelector('.nav-overlay');
            function toggleNav() { body.classList.toggle('nav-open'); }
            if (burger && overlay) {
                burger.addEventListener('click', toggleNav);
                overlay.addEventListener('click', toggleNav);
            }
        })();

        function openModalModifierAgent(button) {
            const agentId = button.dataset.agentId;
            const matricule = button.dataset.matricule || '';
            const nom = button.dataset.nom || '';
            const prenom = button.dataset.prenom || '';
            const telephone = button.dataset.telephone || '';
            const email = button.dataset.email || '';
            const statut = button.dataset.statut || 'actif';
            const dateEmbauche = button.dataset.dateEmbauche || '';
            const username = button.dataset.username || '';
            const notes = button.dataset.notes || '';
            const emplacementsStr = button.dataset.emplacements || '';
            const emplacementsIds = emplacementsStr ? emplacementsStr.split(',').filter(id => id.trim()) : [];
            const acteursStr = button.dataset.acteurs || '';
            const acteursIds = acteursStr ? acteursStr.split(',').filter(id => id.trim()) : [];
            const institutionsStr = button.dataset.institutions || '';
            const institutionsIds = institutionsStr ? institutionsStr.split(',').filter(id => id.trim()) : [];

            document.getElementById('modifier_agent_id').value = agentId;
            document.getElementById('modifier_matricule').value = matricule;
            document.getElementById('modifier_nom').value = nom;
            document.getElementById('modifier_prenom').value = prenom;
            document.getElementById('modifier_telephone').value = telephone;
            document.getElementById('modifier_email').value = email;

            // D√©finir le statut et le libell√© affich√© (Actif/Inactif/Suspendu)
            const statutSelect = document.getElementById('modifier_statut');
            const statutLabel = document.getElementById('modifier_statut_label');
            if (statutSelect) {
                const statutValue = (statut || 'actif').trim();
                const options = Array.from(statutSelect.options);
                const optionExists = options.some(opt => opt.value === statutValue);
                statutSelect.value = optionExists ? statutValue : (options[0] ? options[0].value : 'actif');
                if (statutLabel) {
                    const selected = options.find(opt => opt.value === statutSelect.value);
                    statutLabel.textContent = selected ? selected.textContent : 'Actif';
                }
            }

            document.getElementById('modifier_date_embauche').value = dateEmbauche;
            document.getElementById('modifier_username').value = username;
            document.getElementById('modifier_notes').value = notes;

            // Cocher les emplacements assign√©s
            const emplacementCheckboxes = document.querySelectorAll('.emplacement-checkbox');
            emplacementCheckboxes.forEach(cb => {
                cb.checked = emplacementsIds.includes(cb.value);
            });

            // Cocher les acteurs √©conomiques assign√©s
            const acteurCheckboxes = document.querySelectorAll('.acteur-checkbox');
            acteurCheckboxes.forEach(cb => {
                cb.checked = acteursIds.includes(cb.value);
            });

            // Cocher les institutions financi√®res assign√©es
            const institutionCheckboxes = document.querySelectorAll('.institution-checkbox');
            institutionCheckboxes.forEach(cb => {
                cb.checked = institutionsIds.includes(cb.value);
            });

            document.getElementById('modalModifierAgent').classList.add('active');
        }

        function closeModalModifierAgent() {
            document.getElementById('modalModifierAgent').classList.remove('active');
        }

        // Fermer modale au clic sur le fond
        document.getElementById('modalModifierAgent').addEventListener('click', function(e) {
            if (e.target === this) closeModalModifierAgent();
        });

        // Mettre √† jour le libell√© Statut affich√© quand on change la s√©lection
        (function() {
            const statutSelect = document.getElementById('modifier_statut');
            const statutLabel = document.getElementById('modifier_statut_label');
            if (statutSelect && statutLabel) {
                statutSelect.addEventListener('change', function() {
                    const opt = this.options[this.selectedIndex];
                    statutLabel.textContent = opt ? opt.textContent : 'Actif';
                });
            }
        })();
    </script>
</body>
</html>
